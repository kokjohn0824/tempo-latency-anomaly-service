# Tempo Latency Anomaly Service - æ¶æ§‹è¨­è¨ˆæ–‡ä»¶

## ç³»çµ±æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tempo Latency Anomaly Service                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Grafana Tempo    â”‚         â”‚      External Client       â”‚
â”‚   (Trace Source)   â”‚         â”‚   (Anomaly Check Caller)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                               â”‚
          â”‚ Poll (15s)                    â”‚ HTTP POST
          â”‚                               â”‚
          â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HTTP API Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tempo Poller   â”‚  â”‚ Anomaly Check  â”‚  â”‚ Baseline Get  â”‚  â”‚
â”‚  â”‚    (Job)       â”‚  â”‚   (Handler)    â”‚  â”‚   (Handler)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                  â”‚                     â”‚
            â–¼                  â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Service Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Ingest Service â”‚  â”‚ Check Service  â”‚  â”‚ Baseline Svc  â”‚  â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚               â”‚  â”‚
â”‚  â”‚ â€¢ Parse trace  â”‚  â”‚ â€¢ Fetch cache  â”‚  â”‚ â€¢ Recompute   â”‚  â”‚
â”‚  â”‚ â€¢ Dedup        â”‚  â”‚ â€¢ Apply rule   â”‚  â”‚ â€¢ Update      â”‚  â”‚
â”‚  â”‚ â€¢ Store sample â”‚  â”‚ â€¢ Explain      â”‚  â”‚               â”‚  â”‚
â”‚  â”‚ â€¢ Mark dirty   â”‚  â”‚                â”‚  â”‚               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                  â”‚                     â”‚
            â–¼                  â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Domain Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ TraceEvent        â€¢ TimeBucket (hour, dayType)      â”‚  â”‚
â”‚  â”‚  â€¢ BaselineStats     â€¢ Key Generation Logic            â”‚  â”‚
â”‚  â”‚  â€¢ AnomalyCheck I/O  â€¢ Time Zone Conversion            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                  â”‚                     â”‚
            â–¼                  â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Storage Layer (Redis)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Duration     â”‚  â”‚ Baseline     â”‚  â”‚ Dedup & Dirty    â”‚   â”‚
â”‚  â”‚ Storage      â”‚  â”‚ Cache        â”‚  â”‚ Tracking         â”‚   â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚                  â”‚   â”‚
â”‚  â”‚ dur:{key}    â”‚  â”‚ base:{key}   â”‚  â”‚ seen:{traceID}   â”‚   â”‚
â”‚  â”‚ â†’ LIST       â”‚  â”‚ â†’ HASH       â”‚  â”‚ â†’ SET+TTL        â”‚   â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ dirtyKeys â†’ SET  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                  â”‚                     â”‚
            â–¼                  â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Redis                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è³‡æ–™æ”¶é›†æµç¨‹ (å« Backfill)

å•Ÿå‹•æ™‚å…ˆå›å¡«æ­·å²è³‡æ–™,ä¹‹å¾Œé€²å…¥å›ºå®šé »ç‡çš„è¼ªè©¢ã€‚å›å¡«çµæŸæ™‚é–“æœƒè½åœ¨ã€Œç¾åœ¨ - tempo_lookbackã€,ä»¥é™ä½èˆ‡æ­£å¸¸è¼ªè©¢çš„é‡ç–Šã€‚

```
æ™‚é–“è»¸ (ç¤ºæ„):

[-backfill_duration] â”€â”€(é€æ‰¹å›å¡«: backfill_batch)â”€â”€> [ç¾åœ¨ - tempo_lookback] â”€â”€(æ­£å¸¸è¼ªè©¢: tempo_interval)â”€â”€> [ç¾åœ¨]

        â–² Backfill éšæ®µ                                   â–² æ­£å¸¸è¼ªè©¢éšæ®µ
```

æµç¨‹åœ–:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å•Ÿå‹• Start         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        backfill_enabled?
                â”‚yes                       no
                â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backfill Loop (old â†’ recent) â”‚   â”‚ ç«‹å³åŸ·è¡Œä¸€æ¬¡ tick()     â”‚
â”‚  for t in [now-dur, now-lk): â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    window = [t, t+batch)     â”‚               â”‚
â”‚    Query Tempo (lookbackâ‰ˆnow-t)             â–¼
â”‚    Filter to window           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Ingest samples â†’ Redis     â”‚   â”‚   Regular Polling Loop  â”‚
â”‚    Sleep(1s) rate limit       â”‚   â”‚ every tempo_interval:   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  Query last tempo_lookback
                â”‚                   â”‚  Ingest samples â†’ Redis
                â–¼                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Backfill Done  â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ç«‹å³åŸ·è¡Œä¸€æ¬¡ tick()     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
     (é€²å…¥ Regular Polling)
```

---

## è³‡æ–™æµç¨‹

### 1. æ”å–æµç¨‹ (Ingest Flow)

```
[Tempo] â”€15sâ†’ [Tempo Poller Job]
                     â”‚
                     â–¼
              [Parse Traces]
                     â”‚
                     â–¼
           [Ingest Service] â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚               â”‚
                     â”œâ”€1. Dedup â”€â”€â”€â”€â–¶â”‚ Redis: seen:{traceID}
                     â”‚               â”‚
                     â”œâ”€2. Extract â”€â”€â”€â–¶â”‚ TimeBucket (hour, dayType)
                     â”‚               â”‚
                     â”œâ”€3. Store â”€â”€â”€â”€â–¶â”‚ Redis: dur:{key} LPUSH
                     â”‚               â”‚
                     â””â”€4. Mark â”€â”€â”€â”€â”€â–¶â”‚ Redis: dirtyKeys SADD
```

### 2. é‡ç®—æµç¨‹ (Recompute Flow)

```
[Baseline Recompute Job] â”€30sâ†’ [Pop Dirty Keys]
                                      â”‚
                                      â–¼
                              [Baseline Service]
                                      â”‚
                                      â”œâ”€1. LRANGE dur:{key}
                                      â”‚   (get samples)
                                      â”‚
                                      â–¼
                              [Stats Calculator]
                                      â”‚
                                      â”œâ”€ Calculate p50
                                      â”œâ”€ Calculate p95
                                      â””â”€ Calculate MAD
                                      â”‚
                                      â–¼
                              [Store Results]
                                      â”‚
                                      â””â”€ Redis: base:{key} HSET
```

### 3. æª¢æŸ¥æµç¨‹ (Check Flow)

```
[Client] â”€POST /v1/anomaly/checkâ†’ [Check Handler]
                                         â”‚
                                         â–¼
                                  [Check Service]
                                         â”‚
                                         â”œâ”€1. Parse time bucket
                                         â”‚
                                         â”œâ”€2. HGETALL base:{key}
                                         â”‚   (get cached baseline)
                                         â”‚
                                         â”œâ”€3. Check samples â‰¥ minSamples
                                         â”‚
                                         â”œâ”€4. Apply anomaly rule:
                                         â”‚   durationMs > max(
                                         â”‚     p95 * 2.0,
                                         â”‚     p50 + 10 * MAD
                                         â”‚   )
                                         â”‚
                                         â””â”€5. Generate explanation
                                         â”‚
                                         â–¼
                                  [Return Response]
                                         â”‚
                                         â””â”€ {isAnomaly, bucket, baseline, reason}
```

---

## Key Schema è¨­è¨ˆ

### åŸºæº–ç·š Key æ ¼å¼
```
base:{service}|{endpoint}|{hour}|{dayType}

ç¯„ä¾‹:
base:api-gateway|/users/profile|14|weekday
base:payment-service|/charge|22|weekend
```

### Duration å„²å­˜ Key
```
dur:{service}|{endpoint}|{hour}|{dayType}

çµæ§‹: Redis LIST
å…§å®¹: [durationMs, durationMs, ...]
æœ€å¤§é•·åº¦: 1000 (LTRIM)
```

### Dedup Key
```
seen:{traceID}

çµæ§‹: Redis STRING
TTL: 6 hours
```

### Dirty Tracking
```
dirtyKeys

çµæ§‹: Redis SET
æˆå“¡: base key strings
```

---

## æ™‚é–“æ¡¶ (Time Bucket) è¨­è¨ˆ

### è½‰æ›è¦å‰‡
```python
# 1. å°‡ startTimeUnixNano è½‰ç‚º Asia/Taipei æ™‚å€
local_time = unix_nano_to_local(startTimeUnixNano, tz="Asia/Taipei")

# 2. æå–æ™‚é–“ç‰¹å¾µ
hour = local_time.hour          # 0-23
day_of_week = local_time.weekday()  # 0=Monday, 6=Sunday

# 3. åˆ¤æ–·æ—¥é¡å‹
if day_of_week in [5, 6]:  # Saturday, Sunday
    day_type = "weekend"
else:
    day_type = "weekday"
```

### ç‚ºä½•éœ€è¦æ™‚é–“æ¡¶?
- **å•é¡Œ**: å»¶é²åœ¨ä¸åŒæ™‚æ®µå¯èƒ½å·®ç•°å¾ˆå¤§
  - å‡Œæ™¨ 3:00 å¹³å‡ 50ms æ˜¯æ­£å¸¸
  - ä¸‹åˆ 2:00 å¹³å‡ 200ms ä¹Ÿå¯èƒ½æ­£å¸¸ (é«˜å³°æœŸ)
  
- **è§£æ±º**: ç‚ºæ¯å€‹ (service, endpoint, hour, dayType) ç¶­è­·ç¨ç«‹çš„ baseline
  - 24 å°æ™‚ Ã— 2 æ—¥é¡å‹ = 48 å€‹å¯èƒ½çš„æ¡¶
  - æ¯å€‹ç«¯é»æœ€å¤š 48 å€‹ç¨ç«‹åŸºæº–ç·š

---

## ç•°å¸¸æª¢æ¸¬æ¼”ç®—æ³•

### çµ±è¨ˆæŒ‡æ¨™

#### P50 (Median)
```
p50 = sorted(samples)[len(samples) // 2]
```

#### P95
```
p95 = sorted(samples)[int(len(samples) * 0.95)]
```

#### MAD (Median Absolute Deviation)
```
MAD = median(|x - p50| for x in samples)
```

### ç•°å¸¸è¦å‰‡

```
threshold = max(
    p95 * factor,          # ç›¸å°é–¾å€¼ (é è¨­ factor=2.0)
    p50 + k * MAD          # çµ•å°åå·® (é è¨­ k=10)
)

isAnomaly = (durationMs > threshold)
```

### ç‚ºä½•ä½¿ç”¨ Hybrid æ–¹æ³•?

| æƒ…å¢ƒ | ä½¿ç”¨æŒ‡æ¨™ | åŸå›  |
|------|---------|------|
| ç©©å®šæœå‹™ (ä½è®Šç•°) | p50 + k*MAD | MAD å°æ™‚,ä½¿ç”¨çµ•å°åå·®æ›´æ•æ„Ÿ |
| é«˜è®Šç•°æœå‹™ | p95 * factor | ç›¸å°é–¾å€¼æ›´é©åˆè®Šå‹•å¤§çš„æœå‹™ |
| ä¸€èˆ¬æƒ…æ³ | max(å…©è€…) | å–è¼ƒå¯¬é¬†çš„é–¾å€¼,æ¸›å°‘èª¤å ± |

### åƒæ•¸èª¿æ•´æŒ‡å—

| åƒæ•¸ | é è¨­å€¼ | èª¿é«˜æ•ˆæœ | èª¿ä½æ•ˆæœ |
|------|--------|---------|---------|
| factor | 2.0 | æ¸›å°‘èª¤å ± (æ›´å¯¬é¬†) | å¢åŠ éˆæ•åº¦ |
| k | 10 | æ¸›å°‘èª¤å ± | å¢åŠ éˆæ•åº¦ |
| minSamples | 50 | éœ€è¦æ›´å¤šè³‡æ–™æ‰åˆ¤æ–· | æ›´å¿«é–‹å§‹æª¢æ¸¬ |

---

## æ•ˆèƒ½è¨­è¨ˆåŸå‰‡

### 1. é—œéµè·¯å¾‘å„ªåŒ– (Check API)

**è¦æ±‚**: O(1) æ™‚é–“è¤‡é›œåº¦

**å¯¦ç¾**:
```
âœ… åªè®€å–é è¨ˆç®—çš„ baseline (Redis HGETALL)
âœ… ç°¡å–®æ•¸å­¸æ¯”è¼ƒ (max, åŠ æ³•, ä¹˜æ³•)
âœ… ä¸é€²è¡Œä»»ä½•æ’åºæˆ–çµ±è¨ˆè¨ˆç®—
âœ… ä¸ç­‰å¾…ä»»ä½•èƒŒæ™¯ä»»å‹™
```

**ç¦æ­¢**:
```
âŒ å¯¦æ™‚è¨ˆç®—ç™¾åˆ†ä½æ•¸
âŒ æŸ¥è©¢å¤§é‡æ­·å²è³‡æ–™
âŒ è¤‡é›œçš„ ML æ¨¡å‹æ¨è«–
âŒ é˜»å¡å¼ I/O
```

### 2. èƒŒæ™¯è™•ç†ç­–ç•¥

**Tempo Poller**:
- é–“éš”: 15 ç§’
- å›æŸ¥: 120 ç§’
- ç­–ç•¥: éé˜»å¡,å¤±æ•—é‡è©¦

**Baseline Recompute**:
- é–“éš”: 30 ç§’
- æ‰¹æ¬¡: ä¸€æ¬¡è™•ç†å¤šå€‹ dirty keys
- ç­–ç•¥: æ¼¸é€²å¼æ›´æ–°,ä¸å½±éŸ¿ API

### 3. Redis å„ªåŒ–

**é€£ç·šæ± **:
```yaml
pool_size: 10
min_idle: 5
max_idle: 10
```

**Pipeline ä½¿ç”¨**:
- æ‰¹æ¬¡è®€å–å¤šå€‹ baseline
- æ‰¹æ¬¡æ¨™è¨˜ dirty keys

**è¨˜æ†¶é«”ç®¡ç†**:
- LTRIM é™åˆ¶ LIST é•·åº¦
- TTL è‡ªå‹•æ¸…ç† dedup è¨˜éŒ„

---

## å¯æ“´å±•æ€§è€ƒé‡

### æ°´å¹³æ“´å±•

**ç„¡ç‹€æ…‹è¨­è¨ˆ**:
- âœ… æ‰€æœ‰ç‹€æ…‹å„²å­˜åœ¨ Redis
- âœ… å¯é‹è¡Œå¤šå€‹æœå‹™å¯¦ä¾‹
- âœ… Load balancer å‰ç«¯åˆ†æµ

**æ³¨æ„äº‹é …**:
- Tempo poller å¯èƒ½é‡è¤‡æ‹‰å– (é€é dedup è§£æ±º)
- Baseline recompute å¤šå¯¦ä¾‹åŒæ™‚æ›´æ–° (Redis åŸå­æ€§ä¿è­‰ä¸€è‡´)

### å‚ç›´æ“´å±•

**CPU å¯†é›†**:
- çµ±è¨ˆè¨ˆç®— (æ’åº)
- å¯è€ƒæ…®ä½¿ç”¨ goroutine pool

**è¨˜æ†¶é«”å¯†é›†**:
- å–®å€‹ key æœ€å¤š 1000 samples Ã— 8 bytes = 8KB
- å‡è¨­ 1000 å€‹æ´»èºç«¯é» Ã— 48 æ¡¶ = ~384MB

### Cardinality ç®¡ç†

**æ½›åœ¨çˆ†ç‚¸é»**:
```
services Ã— endpoints Ã— 24 hours Ã— 2 dayTypes
```

**ç·©è§£ç­–ç•¥**:
1. Endpoint åç¨±æ­£è¦åŒ– (ç§»é™¤ ID)
2. è¨­å®š key TTL (ä¾‹å¦‚ 30 å¤©æœªæ›´æ–°è‡ªå‹•éæœŸ)
3. ç›£æ§ key æ•¸é‡
4. é™åˆ¶ service/endpoint çµ„åˆæ•¸é‡

---

## å¯è§€æ¸¬æ€§

### Metrics (å»ºè­°ä½¿ç”¨ Prometheus)

**Ingest**:
- `tempo_traces_ingested_total`
- `tempo_traces_duplicated_total`
- `tempo_poll_duration_seconds`

**Check**:
- `anomaly_checks_total{result="anomaly|normal|insufficient_data"}`
- `anomaly_check_duration_seconds`
- `baseline_cache_hit_total`

**Baseline**:
- `baseline_recompute_total`
- `baseline_dirty_keys_count`
- `baseline_samples_count{service,endpoint}`

### Logs

**çµæ§‹åŒ–æ—¥èªŒ** (JSON):
```json
{
  "level": "info",
  "timestamp": "2026-01-15T10:30:00Z",
  "service": "api-gateway",
  "endpoint": "/users/profile",
  "hour": 10,
  "dayType": "weekday",
  "durationMs": 450,
  "isAnomaly": true,
  "reason": "Duration 450ms exceeds threshold 300ms (p95=150ms)",
  "traceID": "abc123..."
}
```

---

## æ•…éšœè™•ç†

### Tempo ä¸å¯ç”¨
- âœ… Poller æŒçºŒé‡è©¦ (exponential backoff)
- âœ… Check API ä»å¯ä½¿ç”¨ç¾æœ‰ baseline

### Redis ä¸å¯ç”¨
- âŒ æœå‹™ç„¡æ³•é‹ä½œ (å–®é»ä¾è³´)
- ğŸ’¡ å»ºè­°: Redis Sentinel æˆ– Cluster æ¨¡å¼

### Baseline éæœŸ
- å¦‚æœæŸå€‹ key é•·æœŸæœªæ›´æ–°,è¿”å› `INSUFFICIENT_DATA`
- è€ƒæ…®è¨­å®š baseline TTL

### æ¨£æœ¬ä¸è¶³
- Check API è¿”å› `INSUFFICIENT_DATA`
- ç­‰å¾…ç´¯ç©è¶³å¤ æ¨£æœ¬ (minSamples=50)

---

## å®‰å…¨æ€§è€ƒé‡

### API èªè­‰
- å»ºè­°åŠ å…¥ API key æˆ– JWT é©—è­‰
- Rate limiting é˜²æ­¢æ¿«ç”¨

### Tempo èªè­‰
- æ”¯æ´ Bearer token
- é…ç½®æª”æ¡ˆæ•æ„Ÿè³‡è¨Šä½¿ç”¨ç’°å¢ƒè®Šæ•¸

### Redis å®‰å…¨
- ä½¿ç”¨ AUTH å¯†ç¢¼
- TLS åŠ å¯†é€£ç·š
- ç¶²è·¯éš”é›¢

---

## æœªä¾†æ“´å±•æ–¹å‘

### çŸ­æœŸ
1. âœ… åŸºæœ¬åŠŸèƒ½å¯¦ç¾
2. âœ… å–®æ©Ÿéƒ¨ç½²

### ä¸­æœŸ
1. ğŸ”„ Metrics å’Œ Dashboard
2. ğŸ”„ Alert æ•´åˆ (webhook)
3. ğŸ”„ å¤š Tempo source æ”¯æ´

### é•·æœŸ
1. â³ è‡ªé©æ‡‰é–¾å€¼èª¿æ•´
2. â³ å­£ç¯€æ€§æ¨¡å¼æª¢æ¸¬
3. â³ ç•°å¸¸äº‹ä»¶é—œè¯åˆ†æ
4. â³ å¤šç¶­åº¦åˆ†çµ„ (region, cluster)

---

## æŠ€è¡“é¸å‹ç†ç”±

### ç‚ºä½•ç”¨ Go?
- âœ… é«˜ä¸¦ç™¼æ”¯æ´ (goroutines)
- âœ… ç°¡å–®éƒ¨ç½² (å–®ä¸€äºŒé€²ä½æª”)
- âœ… è±å¯Œçš„ HTTP/Redis ç”Ÿæ…‹

### ç‚ºä½•ç”¨ Redis?
- âœ… å¿«é€Ÿè®€å¯« (å¾®ç§’ç´š)
- âœ… è±å¯Œè³‡æ–™çµæ§‹ (LIST, HASH, SET)
- âœ… åŸå­æ“ä½œä¿è­‰
- âœ… TTL è‡ªå‹•éæœŸ

### ç‚ºä½•ä¸ç”¨ ML?
- âŒ ä¸å¯è§£é‡‹ (é»‘ç›’)
- âŒ éœ€è¦è¨“ç·´è³‡æ–™å’Œç®¡ç·š
- âŒ æ¨è«–å»¶é²é«˜
- âœ… çµ±è¨ˆæ–¹æ³•ç°¡å–®ã€å¿«é€Ÿã€å¯è§£é‡‹

---

## ç¸½çµ

é€™å€‹ç³»çµ±æ˜¯ä¸€å€‹**ç”Ÿç”¢ç´šçš„å¯¦æ™‚ç•°å¸¸æª¢æ¸¬æœå‹™**,å…·å‚™:

1. **å¿«é€Ÿ**: Check API < 5ms
2. **æº–ç¢º**: æ™‚é–“æ„ŸçŸ¥ + æ··åˆé–¾å€¼
3. **è‡ªå‹•**: ç„¡éœ€äººå·¥ç¶­è­·
4. **å¯è§£é‡‹**: æ¸…æ™°çš„æ±ºç­–åŸå› 
5. **å¯æ“´å±•**: ç„¡ç‹€æ…‹è¨­è¨ˆ

é—œéµè¨­è¨ˆæ±ºç­–éƒ½åŸºæ–¼**å¯¦ç”¨æ€§**è€Œéè¤‡é›œåº¦,ç¢ºä¿ç³»çµ±ç©©å®šå¯é ã€‚
